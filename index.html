<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sabana Wheels — Demo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #032567;
      margin: 0;
      padding: 20px;
      color: #eee;
    }
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
      padding: 10px 20px;
      position: relative;
    }
    header h1 {
      font-size: 2.4em;
      margin: 0;
      line-height: 1;
    }
    header h2 {
      font-size: 1.2em;
      margin: 0;
      opacity: .9;
    }
    /* Auth buttons container */
    .auth-buttons {
      position: absolute;
      top: 10px;
      right: 20px;
      display: flex;
      align-items: center;
    }
    .auth-buttons button {
      margin-left: 10px;
      padding: 6px 12px;
      background-color: #53AAE4;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    .auth-buttons button:hover { background-color: #4394c8; }

    /* Profile button styling */
    #profileBtn {
      background-color: transparent;
      padding: 5px 10px;
      border: 1px solid white;
      border-radius: 4px;
      cursor: pointer;
    }
    #profileBtn:hover { background-color: #4394c8; }

    section { display: none; color: #000; }
    section.active { display: block; }

    /* Forms */
    form { display:block; }
    input, select, button, textarea {
      box-sizing: border-box;
      font-size: 1rem;
    }
    #signupFormContainer, #loginFormContainer {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      color: #000;
      padding: 16px;
      border-radius: 8px;
      width: 320px;
      box-shadow: 0 4px 20px rgba(0,0,0,.3);
    }
    #signupFormContainer button.closeBtn, #loginFormContainer button.closeBtn {
      float: right;
      background: transparent;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    #signupFormContainer input, #signupFormContainer select,
    #loginFormContainer input {
      display:block;
      width: 100%;
      margin: 8px 0;
      padding: 8px;
    }

    /* Main content */
    #mainContent { display:none; margin-top: 18px; }
    .card {
      background:#8bc3e6;
      color:#000;
      padding:30px;
      border-radius:8px;
      margin-bottom:12px;
    }

    #optionsContainer { margin: 12px 0; }
    #optionsContainer button { margin-right:8px; margin-bottom:8px; padding:8px 12px; }

    /* Rides lists */
    .ride-item { background:#f9f9f9; padding:10px; border-radius:6px; margin-bottom:10px; border:1px solid #ddd; }

    /* Map */
    #map { height: 400px; margin-top: 12px; border-radius:8px; }

    /* small screens */
    @media (max-width:600px) {
      #signupFormContainer, #loginFormContainer { width: 90%; }
    }
  </style>
</head>
<body>
<header>
  <h1>Sabana</h1>
  <h1>Wheels</h1>
  <div class="auth-buttons" id="authButtons">
    <button id="login-btn">Login</button>
    <button id="signup-btn">Sign Up</button>
  </div>
</header>

<!-- Sign-up form container -->
<div id="signupFormContainer" aria-hidden="true">
  <form id="signupForm" class="card">
    <button type="button" class="closeBtn" id="closeSignup">✕</button>
    <h3>Register</h3>

    <label for="role">Are you a driver or passenger?</label>
    <select id="role" required>
      <option value="">Select role</option>
      <option value="passenger">Passenger</option>
      <option value="driver">Driver</option>
    </select>

    <!-- Common fields -->
    <input type="text" id="firstName" placeholder="First Name" required />
    <input type="text" id="lastName" placeholder="Last Name" required />
    <input type="text" id="universityId" placeholder="University ID" required />
    <input type="tel" id="phoneNumber" placeholder="Phone Number" required />
    <input type="email" id="email" placeholder="Email" required />
    <input type="password" id="password" placeholder="Password" required />

    <!-- Driver-specific fields -->
    <div id="driverFields" style="display:none;">
      <input type="text" id="placaVehiculo" placeholder="Vehicle Plate" />
      <label for="fotoVehiculo">Please select a photo of your vehicle:</label>
      <input type="file" accept="image/*" id="fotoVehiculo" />
      <input type="number" id="vehicleCapacity" placeholder="Vehicle Capacity" />
      <label for="fotoSoat">Please select a SOAT photo:</label>
      <input type="file" accept="image/*" id="fotoSoat" />
      <input type="text" id="brand" placeholder="Brand" />
      <input type="text" id="model" placeholder="Model" />
    </div>

    <button type="submit" id="registerBtn">Register</button>
  </form>
</div>

<!-- Login form modal -->
<div id="loginFormContainer" aria-hidden="true">
  <form id="loginForm" class="card">
    <button type="button" class="closeBtn" id="closeLogin">✕</button>
    <h3>Login</h3>
    <input type="email" id="loginEmail" placeholder="Email" required />
    <input type="password" id="loginPassword" placeholder="Password" required />
    <button type="button" id="openForgotPassword">Forgot Password?</button>
    <button type="submit">Login</button>
  </form>
</div>

<!-- Forgot Password -->
<div id="forgotPasswordContainer" aria-hidden="true" style="display:none;">
  <form id="forgotPasswordForm" class="card">
    <button type="button" class="closeBtn" id="closeForgotPassword">✕</button>

    <h3>Reset Password</h3>

    <input type="email" id="forgotEmail" placeholder="Enter your registered email" required>

    <input type="password" id="newPassword" placeholder="New Password" required>
    <input type="password" id="confirmPassword" placeholder="Confirm Password" required>

    <button type="submit">Reset Password</button>
  </form>
</div>

<!-- Main Content -->
<div id="mainContent">
  <div class="card">
    <h3>Welcome, <span id="userName">Guest</span> (<span id="userRole">-</span>)</h3>
    <div id="optionsContainer"></div>
  </div>

  <!-- Driver section -->
  <section id="driverSection" class="card">
    <h3>Create a Ride (Driver)</h3>
    <form id="driverCreateRideForm">
      <input type="text" id="driverVehicle" placeholder="Vehicle Info" required />
      <input type="date" id="driverDate" required />
      <input type="time" id="driverTime" required />
      <input type="text" id="driverDeparture" placeholder="Departure Point" required />
      <input type="text" id="driverArrival" placeholder="Arrival Point" required />
      <input type="number" id="driverSeats" placeholder="Available seats" required min="1" />
      <input type="text" id="driverTarriff" placeholder="Tarriffs Per Passenger" required />
      <button type="submit">Create Ride</button>
    </form>

    <div id="driverRidesList">
      <button type="edit">Edit Ride</button>
      <button type="cancel">Cancel Ride</button>
    </div>
  </section>

  <!-- Passenger section -->
  <section id="passengerSection" class="card">
    <h3>Available Rides</h3>
    <div id="ridesList"></div>
  </section>

  <!-- Travel section -->
  <section id="travel" class="card">
    <h2>Travel</h2>
    <label for="dest-input">Select Your Pickup Point:</label>
    <input type="text" id="dest-input" placeholder="Enter Pickup Point" required />

    <br/><br/>
    <label for="arrival-input">Select your Arrival Point:</label>
    <input type="text" id="arrival-input" placeholder="Enter Arrival Point" required />

    <div id="map"></div>
    <br/>
    <button onclick="startTravelRoute()">Submit Travel</button>
    <button onclick="showSection('home')">Back to Home</button>
  </section>

  <!-- Reserve section -->
  <section id="reserve" class="card">
    <h2>Reserve</h2>
    <form id="reservationForm">
      <label for="dest">Pickup Point:</label>
      <input type="text" id="dest" placeholder="Enter pickup point" required />
      <label for="arrival">Arrival Point:</label>
      <input type="text" id="arrival" placeholder="Enter arrival point" required />
      <label for="date">Date:</label>
      <input type="date" id="reserveDate" required />
      <label for="time">Time:</label>
      <input type="time" id="reserveTime" required />
    </form>
    <button onclick="startTravelRoute()">Submit Travel</button>
    <button onclick="showSection('home')">Back to Home</button>
  </section>
</div>

<script>
 /* frontend.js — use with your existing HTML (replace previous script) */
/* Backend base URL (your Render deployment) */
const API_BASE = "https://entrega-final-be-pia-and-laura-1.onrender.com";

let currentUser = null;
let mapInstance = null;
let routeLine = null;        // for the drawn route
let editingRideId = null;    // if editing a ride, store id here

// Dummy destinations object for map markers (unchanged)
const destinations = {
  "Campus": { name: "Campus", lat: 4.860, lng: -74.030 }
};

// OpenRoute API key (unchanged)
const openRouteApiKey = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImExZTdkNzdiMDJjNTRmNzFiYjRlMmUwMTU4MTY0ZjdkIiwiaCI6Im11cm11cjY0In0=';

/* ---------- DOMContentLoaded: attach handlers ---------- */
window.addEventListener('DOMContentLoaded', () => {
  // Buttons open/close
  document.getElementById('signup-btn').onclick = () => showSignup(true);
  document.getElementById('login-btn').onclick = () => showLogin(true);
  document.getElementById('closeSignup').onclick = () => showSignup(false);
  document.getElementById('closeLogin').onclick = () => showLogin(false);

  // Role select visibility
  const roleSelect = document.getElementById('role');
  if (roleSelect) {
    roleSelect.addEventListener('change', e => {
      document.getElementById('driverFields').style.display = e.target.value === 'driver' ? 'block' : 'none';
    });
  }

  // Signup form (calls backend)
  const signupForm = document.getElementById('signupForm');
  if (signupForm) signupForm.onsubmit = async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim().toLowerCase();
    const role = document.getElementById('role').value;
    if (!email || !role) return alert('Please complete required fields.');

    const payload = {
      name: (document.getElementById('firstName').value || "") + " " + (document.getElementById('lastName').value || ""),
      email,
      password: document.getElementById('password').value,
      role
    };

    try {
      const res = await fetch(`${API_BASE}/signup`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      if (!res.ok) return alert(json.message || 'Signup failed.');
      alert('Registered! You can log in now.');
      showSignup(false);
    } catch (err) {
      console.error('Signup error', err);
      alert('Network error during signup.');
    }
  };

  // Login form (calls backend)
  const loginForm = document.getElementById('loginForm');
  if (loginForm) loginForm.onsubmit = async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value.trim().toLowerCase();
    const pwd = document.getElementById('loginPassword').value;
    try {
      const res = await fetch(`${API_BASE}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password: pwd })
      });
      const json = await res.json();
      if (!res.ok) {
        return alert(json.message || 'Login failed.');
      }

      // Expect backend to return user object (if your server returns different shape, adjust)
      currentUser = json.user || { email, name: json.name, role: json.role };
      // keep a tiny session locally so page reloads keep the user
      localStorage.setItem('sw_session', JSON.stringify({ email: currentUser.email }));
      showLogin(false);
      showMain();
    } catch (err) {
      console.error('Login error', err);
      alert('Network error during login.');
    }
  };

  // Forgot password UI (attempt a backend reset; fallback message if endpoint missing)
  const forgotModal = document.getElementById("forgotPasswordContainer");
  const openForgotBtn = document.getElementById("openForgotPassword");
  const closeForgotBtn = document.getElementById("closeForgotPassword");
  if (openForgotBtn) openForgotBtn.onclick = () => {
    forgotModal.style.display = "block";
    forgotModal.setAttribute("aria-hidden", "false");
  };
  if (closeForgotBtn) closeForgotBtn.onclick = () => {
    forgotModal.style.display = "none";
    forgotModal.setAttribute("aria-hidden", "true");
  };
  const forgotForm = document.getElementById("forgotPasswordForm");
  if (forgotForm) forgotForm.onsubmit = async (e) => {
    e.preventDefault();
    const email = document.getElementById("forgotEmail").value.trim().toLowerCase();
    const newPass = document.getElementById("newPassword").value.trim();
    const confirmPass = document.getElementById("confirmPassword").value.trim();
    if (!email || !newPass || !confirmPass) return alert("All fields are required.");
    if (newPass !== confirmPass) return alert("Passwords do not match!");

    // try calling backend reset endpoint (if implemented)
    try {
      const res = await fetch(`${API_BASE}/reset-password`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password: newPass })
      });
      const json = await res.json();
      if (res.ok) {
        alert("Password reset successfully! Please log in.");
        forgotModal.style.display = "none";
        showLogin(true);
      } else {
        // if backend doesn't have reset endpoint, show helpful message
        alert(json.message || "Reset endpoint not available on server. Contact admin or implement /reset-password.");
      }
    } catch (err) {
      console.warn("Reset request failed:", err);
      alert("Network error — could not reset password. If your backend doesn't support resets you can implement it server-side.");
    }
  };

  // Session load
  const session = JSON.parse(localStorage.getItem('sw_session') || "null");
  if (session && session.email) {
    // fetch user from backend (if endpoint exists); else use session email only
    try {
      const res = await fetch(`${API_BASE}/user/${encodeURIComponent(session.email)}`);
      if (res.ok) {
        const json = await res.json();
        currentUser = json.user || { email: session.email };
      } else {
        // fallback minimal session
        currentUser = { email: session.email };
      }
    } catch (err) {
      currentUser = { email: session.email };
    }
    showMain();
  }

  // Driver create/edit ride form submit
  const driverForm = document.getElementById('driverCreateRideForm');
  if (driverForm) driverForm.onsubmit = async (e) => {
    e.preventDefault();
    if (!currentUser || currentUser.role !== 'driver') {
      return alert('Only drivers can create rides.');
    }

    // gather ride data
    const rideData = {
      driverId: currentUser.email || currentUser.id,
      vehicle: document.getElementById('driverVehicle').value.trim(),
      date: document.getElementById('driverDate').value,
      time: document.getElementById('driverTime').value,
      departure: document.getElementById('driverDeparture').value.trim(),
      arrival: document.getElementById('driverArrival').value.trim(),
      seats: parseInt(document.getElementById('driverSeats').value, 10),
      tariff: document.getElementById('driverTarriff').value,
      createdAt: new Date().toISOString()
    };

    try {
      if (editingRideId) {
        // send PUT to update existing ride
        const res = await fetch(`${API_BASE}/ride/${editingRideId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(rideData)
        });
        const json = await res.json();
        if (!res.ok) return alert(json.message || "Failed to update ride.");
        alert('Ride updated!');
        editingRideId = null;
      } else {
        // create new ride
        const res = await fetch(`${API_BASE}/ride/create`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(rideData)
        });
        const json = await res.json();
        if (!res.ok) return alert(json.message || "Failed to create ride.");
        alert('Ride created!');
      }

      driverForm.reset();
      loadDriverRides();
    } catch (err) {
      console.error('Ride create/edit error', err);
      alert('Network error while creating/updating ride.');
    }
  };
});

/* ---------- UI helper functions ---------- */
function showSignup(show) {
  document.getElementById('signupFormContainer').style.display = show ? 'block' : 'none';
  document.getElementById('signupFormContainer').setAttribute('aria-hidden', !show);
}
function showLogin(show) {
  document.getElementById('loginFormContainer').style.display = show ? 'block' : 'none';
  document.getElementById('loginFormContainer').setAttribute('aria-hidden', !show);
}

/* ---------- Main UI after login ---------- */
function showMain() {
  document.getElementById('mainContent').style.display = 'block';
  document.getElementById('authButtons').style.display = 'none';
  document.getElementById('userName').innerText = currentUser ? (currentUser.firstName || currentUser.name || currentUser.email) : 'Guest';
  document.getElementById('userRole').innerText = currentUser ? currentUser.role : '-';

  const optionsContainer = document.getElementById('optionsContainer');
  optionsContainer.innerHTML = '';

  // Home
  const homeBtn = document.createElement('button');
  homeBtn.innerText = 'Home';
  homeBtn.onclick = () => showSection('home');
  optionsContainer.appendChild(homeBtn);

  // Role toggle (local only — also synced to backend if you implement endpoint later)
  const toggleBtn = document.createElement('button');
  toggleBtn.innerText = currentUser.role === 'driver' ? 'Switch to Passenger' : 'Switch to Driver';
  toggleBtn.onclick = async () => {
    // update locally
    currentUser.role = currentUser.role === 'driver' ? 'passenger' : 'driver';
    // optionally update backend user object (if endpoint exists)
    try {
      await fetch(`${API_BASE}/user/${encodeURIComponent(currentUser.email)}/role`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ role: currentUser.role })
      });
    } catch (err) {
      // ignore network errors for role flip
    }
    alert(`Role changed to ${currentUser.role}`);
    showMain();
  };
  optionsContainer.appendChild(toggleBtn);

  if (currentUser.role === 'driver') {
    const createRideBtn = document.createElement('button');
    createRideBtn.innerText = 'Create a Ride';
    createRideBtn.onclick = () => showSection('driverSection');
    optionsContainer.appendChild(createRideBtn);

    const myRidesBtn = document.createElement('button');
    myRidesBtn.innerText = 'My Rides';
    myRidesBtn.onclick = loadDriverRides;
    optionsContainer.appendChild(myRidesBtn);
  } else {
    const viewRidesBtn = document.createElement('button');
    viewRidesBtn.innerText = 'View Available Rides';
    viewRidesBtn.onclick = loadRidesForPassenger;
    optionsContainer.appendChild(viewRidesBtn);

    const travelBtn = document.createElement('button');
    travelBtn.innerText = 'Travel';
    travelBtn.onclick = () => showSection('travel');
    optionsContainer.appendChild(travelBtn);

    const reserveBtn = document.createElement('button');
    reserveBtn.innerText = 'Reserve a Ride';
    reserveBtn.onclick = () => showSection('reserve');
    optionsContainer.appendChild(reserveBtn);
  }

  const logoutBtn = document.createElement('button');
  logoutBtn.innerText = 'Logout';
  logoutBtn.onclick = logout;
  optionsContainer.appendChild(logoutBtn);

  showSection('home');
}

/* ---------- Change section ---------- */
function showSection(sectionId) {
  const driverSection = document.getElementById('driverSection');
  const passengerSection = document.getElementById('passengerSection');
  const travel = document.getElementById('travel');
  const reserve = document.getElementById('reserve');

  // hide all
  [driverSection, passengerSection, travel, reserve].forEach(s => s && (s.style.display = 'none'));

  if (sectionId === 'home') {
    if (currentUser.role === 'driver') {
      driverSection.style.display = 'block';
      loadDriverRides();
    } else {
      passengerSection.style.display = 'block';
      loadRidesForPassenger();
    }
    return;
  }

  if (sectionId === 'driverSection') { driverSection.style.display = 'block'; loadDriverRides(); }
  if (sectionId === 'passengerSection') { passengerSection.style.display = 'block'; loadRidesForPassenger(); }
  if (sectionId === 'travel') { travel.style.display = 'block'; initMapIfNeeded(); updateMapFromSelects(); }
  if (sectionId === 'reserve') { reserve.style.display = 'block'; }
}

/* ---------- Logout ---------- */
function logout() {
  currentUser = null;
  localStorage.removeItem('sw_session');
  document.getElementById('mainContent').style.display = 'none';
  document.getElementById('authButtons').style.display = 'flex';
  alert('Logged out.');
}

/* ---------- Driver rides (fetch from backend) ---------- */
async function loadDriverRides() {
  if (!currentUser || !currentUser.email) return;
  try {
    const res = await fetch(`${API_BASE}/rides/driver/${encodeURIComponent(currentUser.email)}`);
    if (!res.ok) {
      console.warn('Failed to fetch driver rides');
      document.getElementById('driverRidesList').innerHTML = '<p>Unable to load rides.</p>';
      return;
    }
    const data = await res.json();
    renderDriverRides(data || []);
  } catch (err) {
    console.error('loadDriverRides error', err);
    document.getElementById('driverRidesList').innerHTML = '<p>Network error.</p>';
  }
}

function renderDriverRides(rides) {
  const container = document.getElementById('driverRidesList');
  container.innerHTML = '';
  if (!Array.isArray(rides) || rides.length === 0) {
    container.innerHTML = '<p>No rides yet.</p>';
    return;
  }

  rides.forEach(r => {
    const div = document.createElement('div');
    div.className = 'ride-item';
    div.innerHTML = `
      <strong>${escapeHtml(r.vehicle)}</strong><br/>
      <strong>Date:</strong> ${r.date || 'N/A'} ${r.time || ''}<br/>
      <strong>Pickup:</strong> ${escapeHtml(r.departure || 'N/A')}<br/>
      <strong>Arrival:</strong> ${escapeHtml(r.arrival || 'N/A')}<br/>
      <strong>Seats:</strong> ${r.seats ?? 'N/A'}<br/>
      <strong>Tariff:</strong> ${r.tariff ?? r.tarriff ?? 'N/A'}<br/>
      Created: ${new Date(r.createdAt || Date.now()).toLocaleString()}
    `;

    // Edit button
    const editBtn = document.createElement('button');
    editBtn.textContent = 'Edit';
    editBtn.onclick = () => beginEditRide(r);
    div.appendChild(editBtn);

    // Cancel/Delete button
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancel';
    cancelBtn.style.background = 'red';
    cancelBtn.style.color = 'white';
    cancelBtn.onclick = () => cancelRide(r.id);
    div.appendChild(cancelBtn);

    container.appendChild(div);
  });
}

/* ---------- Passenger rides (fetch all) ---------- */
async function loadRidesForPassenger() {
  try {
    const res = await fetch(`${API_BASE}/rides/all`);
    if (!res.ok) {
      document.getElementById('ridesList').innerHTML = '<p>Unable to load rides.</p>';
      return;
    }
    const data = await res.json();
    renderAvailableRides(data || []);
  } catch (err) {
    console.error('loadRidesForPassenger error', err);
    document.getElementById('ridesList').innerHTML = '<p>Network error.</p>';
  }
}

function renderAvailableRides(rides) {
  const container = document.getElementById('ridesList');
  container.innerHTML = '';
  if (!Array.isArray(rides) || rides.length === 0) {
    container.innerHTML = '<p>No rides available yet.</p>';
    return;
  }
  rides.sort((a,b) => new Date(a.time || a.createdAt) - new Date(b.time || b.createdAt));
  rides.forEach(r => {
    const div = document.createElement('div');
    div.className = 'ride-item';
    div.innerHTML = `
      <strong>${escapeHtml(r.vehicle)}</strong> — by ${escapeHtml(r.ownerName || r.driverId || 'Driver')}<br/>
      Time: ${r.time || 'N/A'} — Pickup: ${escapeHtml(r.departure || 'N/A')} — Seats: ${r.seats ?? 'N/A'}<br/>
      Arrival: ${escapeHtml(r.arrival || 'N/A')} — Tariff: ${r.tariff ?? r.tarriff ?? 'N/A'}<br/>
      Created: ${new Date(r.createdAt || Date.now()).toLocaleString()}
    `;

    // Reserve button
    const reserveBtn = document.createElement('button');
    reserveBtn.textContent = 'Reserve';
    reserveBtn.onclick = () => reserveRide(r.id);
    div.appendChild(reserveBtn);

    container.appendChild(div);
  });
}

/* ---------- Reserve ride (passenger) ---------- */
async function reserveRide(rideId) {
  if (!currentUser || !currentUser.email) return alert('Please login to reserve.');
  try {
    const res = await fetch(`${API_BASE}/ride/${rideId}/reserve`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ passengerId: currentUser.email })
    });
    const json = await res.json();
    if (!res.ok) return alert(json.message || 'Failed to reserve ride.');
    alert('Ride reserved!');
    loadRidesForPassenger();
  } catch (err) {
    console.error('reserveRide error', err);
    alert('Network error while reserving.');
  }
}

/* ---------- Cancel ride (driver) ---------- */
async function cancelRide(rideId) {
  if (!confirm('Are you sure you want to cancel this ride?')) return;
  try {
    const res = await fetch(`${API_BASE}/ride/${rideId}`, { method: "DELETE" });
    const json = await res.json();
    if (!res.ok) return alert(json.message || 'Failed to cancel ride.');
    alert('Ride canceled.');
    loadDriverRides();
  } catch (err) {
    console.error('cancelRide error', err);
    alert('Network error while canceling.');
  }
}

/* ---------- Edit ride flow ---------- */
function beginEditRide(ride) {
  // prefill the form
  document.getElementById('driverVehicle').value = ride.vehicle || '';
  if (ride.date) document.getElementById('driverDate').value = ride.date;
  if (ride.time) document.getElementById('driverTime').value = ride.time;
  document.getElementById('driverDeparture').value = ride.departure || '';
  document.getElementById('driverArrival').value = ride.arrival || '';
  document.getElementById('driverSeats').value = ride.seats ?? '';
  document.getElementById('driverTarriff').value = ride.tariff ?? ride.tarriff ?? '';
  editingRideId = ride.id;
  showSection('driverSection');
  alert('Edit the ride and press Create Ride to submit changes.');
}

/* ---------- Map + routing helpers (unchanged) ---------- */
function initMapIfNeeded() {
  if (mapInstance) return;
  mapInstance = L.map('map', { zoomControl: true }).setView([4.86, -74.03], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(mapInstance);

  Object.keys(destinations).forEach(key => {
    const d = destinations[key];
    L.marker([d.lat, d.lng]).addTo(mapInstance).bindPopup(d.name);
  });
}

function updateMapFromSelects() {
  initMapIfNeeded();
  const destVal = document.getElementById('dest-input') ? document.getElementById('dest-input').value : '';
  const arrivalVal = document.getElementById('arrival-input') ? document.getElementById('arrival-input').value : '';
  const points = [];
  if (destVal && destinations[destVal]) points.push([destinations[destVal].lat, destinations[destVal].lng]);
  if (arrivalVal && destinations[arrivalVal]) points.push([destinations[arrivalVal].lat, destinations[arrivalVal].lng]);

  if (points.length === 0) mapInstance.setView([4.86, -74.03], 11);
  else if (points.length === 1) mapInstance.setView(points[0], 13);
  else mapInstance.fitBounds(L.latLngBounds(points).pad(0.5));
}

async function geocodeLocation(location) {
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`;
  try {
    const response = await fetch(url);
    const data = await response.json();
    if (data && data.length > 0) {
      return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
    } else {
      alert('Location not found: ' + location);
      return null;
    }
  } catch (err) {
    console.error('Geocoding error:', err);
    alert('Error geocoding location.');
    return null;
  }
}

async function drawRoute(startCoords, endCoords) {
  const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${openRouteApiKey}`;
  const body = { coordinates: [startCoords, endCoords] };
  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await response.json();
    if (data.features && data.features.length > 0) {
      const routeCoords = data.features[0].geometry.coordinates;
      const latLngs = routeCoords.map(c => [c[1], c[0]]);
      if (routeLine) mapInstance.removeLayer(routeLine);
      routeLine = L.polyline(latLngs, { color: 'blue', weight: 4 }).addTo(mapInstance);
      mapInstance.fitBounds(routeLine.getBounds());
    } else {
      alert('No route found.');
    }
  } catch (err) {
    console.error('Error fetching route:', err);
    alert('Failed to fetch route. Check API key and network.');
  }
}

async function startTravelRoute() {
  const pickup = document.getElementById("dest-input").value;
  const arrival = document.getElementById("arrival-input").value;
  if (!pickup || !arrival) return alert("Please enter both pickup and arrival locations.");
  const start = await geocodeLocation(pickup);
  const end = await geocodeLocation(arrival);
  if (!start || !end) return;
  await drawRoute([start.lng, start.lat], [end.lng, end.lat]);
}

/* ---------- small helpers ---------- */
function escapeHtml(str = '') {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}
</script>
</body>

</html>
